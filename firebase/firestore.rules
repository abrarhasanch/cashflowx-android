rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: ensure user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == uid;
      allow update, delete: if isAuthenticated() && request.auth.uid == uid;
    }

    // Shelves collection
    match /shelves/{shelfId} {
      // Read: authenticated users can read shelves they're members of
      allow read: if isAuthenticated();

      // Create: authenticated user must be the owner
      allow create: if isAuthenticated() 
                    && request.resource.data.ownerUid == request.auth.uid;

      // Update: owner or members can update
      allow update: if isAuthenticated() 
                    && (resource.data.ownerUid == request.auth.uid 
                        || request.auth.uid in resource.data.memberUids);

      // Delete: only owner can delete
      allow delete: if isAuthenticated() 
                    && resource.data.ownerUid == request.auth.uid;

      // Books inside a shelf
      match /books/{bookId} {
        allow read: if isAuthenticated();
        
        // Create: any authenticated user can create (shelf membership checked by app)
        allow create: if isAuthenticated();

        // Update/delete: authenticated users
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();

        // Transactions subcollection
        match /transactions/{txnId} {
          allow read, write: if isAuthenticated();
        }

        // Contacts subcollection
        match /contacts/{contactId} {
          allow read, write: if isAuthenticated();
        }

        // Friends Loans subcollection
        match /friends_loans/{pairId} {
          allow read, write: if isAuthenticated();

          // Events inside loans
          match /events/{eventId} {
            allow read, write: if isAuthenticated();
          }
        }
      }
    }

    // Invitations
    match /invitations/{inviteId} {
      allow read, write: if isAuthenticated();
    }
  }
}
